<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—ñ–∫—Å–µ–ª—å–Ω–∏–π –ê—Ä—Ç –†–µ–¥–∞–∫—Ç–æ—Ä</title>
    <!-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –°—Ç–∏–ª—å —à—Ä–∏—Ñ—Ç—É Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* –°–≤—ñ—Ç–ª–æ-—Å—ñ—Ä–∏–π —Ñ–æ–Ω */
        }
        /* –°—Ç–∏–ª—ñ –¥–ª—è –∫–∞–Ω–≤–∞—Å—É, —â–æ–± –≤—ñ–Ω –±—É–≤ –∫–≤–∞–¥—Ä–∞—Ç–Ω–∏–º —ñ –∞–¥–∞–ø—Ç–∏–≤–Ω–∏–º */
        #pixelCanvasContainer {
            width: 100%;
            max-width: 600px; /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ —à–∏—Ä–∏–Ω–∞ –¥–ª—è –≤–µ–ª–∏–∫–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤ */
            aspect-ratio: 1 / 1;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 1rem;
            overflow: hidden;
            background-color: #fff;
        }
        #pixelCanvas {
            display: block;
            touch-action: none; /* –ó–∞–ø–æ–±—ñ–≥–∞—î –ø—Ä–æ–∫—Ä—É—á—É–≤–∞–Ω–Ω—é –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—ñ–¥ —á–∞—Å –º–∞–ª—é–≤–∞–Ω–Ω—è */
        }
        /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è */
        .action-button {
            transition: all 0.3s ease;
            transform: translateY(0);
        }
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5);
        }
        /* –°—Ç–∏–ª—å –¥–ª—è –Ω–µ–≤–µ–ª–∏–∫–∏—Ö –∫–Ω–æ–ø–æ–∫ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ */
        .tool-button-small {
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
            min-width: 60px; /* –ú—ñ–Ω—ñ–º—É–º –¥–ª—è —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è —ñ–∫–æ–Ω–æ–∫ */
        }
        /* –ü—Ä–∏—Ö–æ–≤–∞–Ω–Ω—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –≤–∏–≥–ª—è–¥—É input type="range" */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –ì–∞–ª–µ—Ä–µ—ó */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ –≤–∏–ª—ñ—Ç–∞—é—á–æ–≥–æ —Å–ø–∏—Å–∫—É */
        .flyout-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .flyout-item:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex flex-col items-center min-h-screen">

    <div class="max-w-4xl w-full">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-8 text-center">
            üé® –ü—ñ–∫—Å–µ–ª—å–Ω–∏–π –ê—Ä—Ç –†–µ–¥–∞–∫—Ç–æ—Ä
        </h1>

        <!-- –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞ –ø–∞–Ω–µ–ª—å -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8 grid grid-cols-2 md:grid-cols-4 gap-4 items-end">
            
            <!-- –í–∏–±—ñ—Ä –∫–æ–ª—å–æ—Ä—É -->
            <div class="col-span-1">
                <label for="colorPicker" class="block text-sm font-medium text-gray-700 mb-1">–ö–æ–ª—ñ—Ä</label>
                <input type="color" id="colorPicker" value="#3b82f6" class="w-full h-10 rounded-lg border-2 border-gray-300 cursor-pointer">
            </div>
            
            <!-- –í–∏–±—ñ—Ä —Ä–æ–∑–º—ñ—Ä—É —Å—ñ—Ç–∫–∏ -->
            <div class="col-span-1">
                <label for="gridSizeSlider" class="block text-sm font-medium text-gray-700 mb-1">
                    –†–æ–∑–º—ñ—Ä —Å—ñ—Ç–∫–∏: <span id="gridSizeValue" class="font-semibold text-blue-600">16x16</span>
                </label>
                <input type="range" id="gridSizeSlider" min="8" max="64" step="8" value="16" class="w-full">
            </div>

            <!-- –í–∏–±—ñ—Ä —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É (–í–∏–ª—ñ—Ç–∞—é—á–∏–π —Å–ø–∏—Å–æ–∫) -->
            <div class="col-span-2 md:col-span-1 relative">
                <label class="block text-sm font-medium text-gray-700 mb-1">–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</label>
                
                <!-- –ì–æ–ª–æ–≤–Ω–∞ –∫–Ω–æ–ø–∫–∞ –¥–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è —Å–ø–∏—Å–∫—É -->
                <button id="mainToolButton" class="w-full bg-blue-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-blue-700 transition duration-150 shadow-md flex items-center justify-center space-x-2">
                    <span id="toolIcon">‚úèÔ∏è</span>
                    <span>–û–ª—ñ–≤–µ—Ü—å</span>
                    <!-- –Ü–∫–æ–Ω–∫–∞ —Å—Ç—Ä—ñ–ª–∫–∏ –≤–Ω–∏–∑ -->
                    <svg id="toolArrow" class="w-4 h-4 ml-1 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>

                <!-- –í–∏–ª—ñ—Ç–∞—é—á–∏–π —Å–ø–∏—Å–æ–∫ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ -->
                <div id="toolFlyout" class="absolute hidden top-full mt-2 w-48 bg-white rounded-lg shadow-xl z-10 border border-gray-200 right-0">
                    <div id="penToolButton" data-tool="pen" class="flyout-item rounded-t-lg">
                        <span class="mr-2">‚úèÔ∏è</span> –û–ª—ñ–≤–µ—Ü—å
                    </div>
                    <div id="rainbowToolButton" data-tool="rainbow" class="flyout-item">
                        <span class="mr-2">üåà</span> –†–∞–π–¥—É–∂–Ω–∏–π –û–ª—ñ–≤–µ—Ü—å
                    </div>
                    <div id="randomToolButton" data-tool="random" class="flyout-item">
                        <span class="mr-2">üé≤</span> –†–∞–Ω–¥–æ–º–Ω–∏–π –ü–µ–Ω–∑–ª–∏–∫
                    </div>
                    <div id="eraserToolButton" data-tool="eraser" class="flyout-item">
                        <span class="mr-2">üßº</span> –ì—É–º–∫–∞
                    </div>
                    <div id="fillToolButton" data-tool="fill" class="flyout-item rounded-b-lg">
                        <span class="mr-2">üß∫</span> –ó–∞–ª–∏–≤–∫–∞
                    </div>
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∏ –¥—ñ–π -->
            <div class="flex space-x-2 col-span-2 md:col-span-1">
                 <button id="clearButton" class="flex-1 bg-yellow-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-yellow-600 transition duration-150 shadow-md">
                    –û—á–∏—Å—Ç–∏—Ç–∏
                </button>
                <button id="saveButton" class="action-button flex-1 bg-indigo-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-indigo-600 transition duration-150 shadow-lg">
                    –ó–±–µ—Ä–µ–≥—Ç–∏ üíæ
                </button>
            </div>

            <div class="col-span-2 flex space-x-2">
                <button id="galleryButton" class="action-button flex-1 bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-150 shadow-lg">
                    –ì–∞–ª–µ—Ä–µ—è üñºÔ∏è
                </button>
                <button id="downloadButton" class="action-button flex-1 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-150 shadow-lg">
                    –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PNG
                </button>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞–Ω–≤–∞—Å—É -->
        <div id="pixelCanvasContainer" class="mx-auto">
            <canvas id="pixelCanvas" width="600" height="600"></canvas>
        </div>

        <p class="text-center text-gray-500 mt-4 text-sm sm:text-base">
            –û–ª—ñ–≤–µ—Ü—å/–ì—É–º–∫–∞/–†–∞–π–¥—É–≥–∞/–†–∞–Ω–¥–æ–º: –ö–ª–∞—Ü–Ω—ñ—Ç—å –∞–±–æ –ø–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å. –ó–∞–ª–∏–≤–∫–∞: –ö–ª–∞—Ü–Ω—ñ—Ç—å –æ–¥–∏–Ω —Ä–∞–∑.
        </p>
        
        <!-- –ú—ñ—Å—Ü–µ –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –ø—Ä–æ —Å—Ç–∞–Ω -->
        <div id="statusMessage" class="text-center mt-4 p-3 bg-green-100 text-green-700 rounded-lg hidden" role="alert"></div>

        <!-- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Firebase -->
        <div id="firebase-init-status" class="text-xs text-gray-400 mt-8 text-center"></div>

    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ì–∞–ª–µ—Ä–µ—ó (Flyout List) -->
    <div id="galleryModal" class="modal-overlay hidden">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 md:w-3/4 lg:w-1/2 max-h-[90vh] flex flex-col">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ -->
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">–í–∞—à–∞ –ü—ñ–∫—Å–µ–ª—å–Ω–∞ –ì–∞–ª–µ—Ä–µ—è</h2>
                <button id="closeGalleryButton" class="text-gray-400 hover:text-gray-600 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö —Ä–æ–±—ñ—Ç -->
            <div id="galleryList" class="p-4 overflow-y-auto flex-1">
                <!-- –°—é–¥–∏ –±—É–¥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏—Å—è —Å–ø–∏—Å–æ–∫ –∞—Ä—Ç—ñ–≤ –∑ Firestore -->
                <p class="text-center text-gray-500 py-4">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≥–∞–ª–µ—Ä–µ—ó...</p>
            </div>
            
            <!-- –ü—ñ–¥–≤–∞–ª -->
            <div class="p-4 border-t text-sm text-gray-500 text-center">
                –ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —É –≤–∞—à–æ–º—É –æ—Å–æ–±–∏—Å—Ç–æ–º—É —Å—Ö–æ–≤–∏—â—ñ Firebase.
            </div>
        </div>
    </div>

    <script type="module">
        // –Ü–º–ø–æ—Ä—Ç–∏ Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('Debug');

        // –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        let isAuthReady = false;

        /**
         * –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Firebase —Ç–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è.
         */
        async function setupFirebase() {
            if (!firebaseConfig) {
                console.warn("Firebase config not available. Skipping Firebase setup.");
                document.getElementById('firebase-init-status').textContent = "Firebase –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ (–∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –≤—ñ–¥—Å—É—Ç–Ω—è).";
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 1. –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 2. –ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ —Å–ª—É—Ö–∞—á–∞ —Å—Ç–∞–Ω—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('firebase-init-status').textContent = `Firebase —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á ID: ${userId} | App ID: ${appId}`;
                        isAuthReady = true;
                        setupGalleryListener(); // –ü–æ—á–∞—Ç–∏ —Å–ª—É—Ö–∞—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –∞—Ä—Ç–∏
                    } else {
                        document.getElementById('firebase-init-status').textContent = "Firebase: –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∏–π—à–æ–≤.";
                        isAuthReady = false;
                    }
                });

            } catch (error) {
                console.error("Firebase setup failed:", error);
                document.getElementById('firebase-init-status').textContent = `–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó Firebase: ${error.message}`;
            }
        }

        // ---------------------------------------------
        // –õ–æ–≥—ñ–∫–∞ –ü—ñ–∫—Å–µ–ª—å–Ω–æ–≥–æ –†–µ–¥–∞–∫—Ç–æ—Ä–∞ —Ç–∞ Firebase
        // ---------------------------------------------

        const canvas = document.getElementById('pixelCanvas');
        const ctx = canvas.getContext('2d');
        const colorPicker = document.getElementById('colorPicker');
        const gridSizeSlider = document.getElementById('gridSizeSlider');
        const gridSizeValueDisplay = document.getElementById('gridSizeValue');
        const clearButton = document.getElementById('clearButton');
        const downloadButton = document.getElementById('downloadButton');
        const canvasContainer = document.getElementById('pixelCanvasContainer');
        const statusMessage = document.getElementById('statusMessage');
        
        // –ù–æ–≤—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –¥–ª—è flyout
        const mainToolButton = document.getElementById('mainToolButton');
        const toolIcon = document.getElementById('toolIcon');
        const toolNameDisplay = mainToolButton.querySelector('span:nth-child(2)');
        const toolFlyout = document.getElementById('toolFlyout');
        const toolArrow = document.getElementById('toolArrow');

        // –ï–ª–µ–º–µ–Ω—Ç–∏ –¥–ª—è –ì–∞–ª–µ—Ä–µ—ó/–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è
        const saveButton = document.getElementById('saveButton');
        const galleryButton = document.getElementById('galleryButton');
        const galleryModal = document.getElementById('galleryModal');
        const galleryList = document.getElementById('galleryList');

        let GRID_SIZE = parseInt(gridSizeSlider.value);
        let PIXEL_DATA = [];
        let currentColor = colorPicker.value;
        let isDrawing = false;
        let currentTool = 'pen'; 
        let savedArts = []; // –õ–æ–∫–∞–ª—å–Ω–µ —Å—Ö–æ–≤–∏—â–µ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö —Ä–æ–±—ñ—Ç

        const toolMap = {
            'pen': { icon: '‚úèÔ∏è', name: '–û–ª—ñ–≤–µ—Ü—å', color: 'bg-blue-600' },
            'rainbow': { icon: 'üåà', name: '–†–∞–π–¥—É–∂–Ω–∏–π', color: 'bg-pink-600' },
            'random': { icon: 'üé≤', name: '–†–∞–Ω–¥–æ–º', color: 'bg-green-600' }, // –ù–æ–≤–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç!
            'eraser': { icon: 'üßº', name: '–ì—É–º–∫–∞', color: 'bg-yellow-600' }, 
            'fill': { icon: 'üß∫', name: '–ó–∞–ª–∏–≤–∫–∞', color: 'bg-indigo-600' }
        };

        // –ö–æ–ª—å–æ—Ä–∏ –¥–ª—è —Ä–∞–π–¥—É–∂–Ω–æ–≥–æ –æ–ª—ñ–≤—Ü—è —Ç–∞ —ñ–Ω–¥–µ–∫—Å –¥–ª—è —Ü–∏–∫–ª—É
        const RAINBOW_COLORS = ['#ff0000', '#ff8800', '#ffff00', '#00ff00', '#0000ff', '#4b0082', '#9400d3']; 
        let rainbowIndex = 0;


        /**
         * –ì–µ–Ω–µ—Ä—É—î –≤–∏–ø–∞–¥–∫–æ–≤–∏–π —à—ñ—Å—Ç–Ω–∞–¥—Ü—è—Ç–∫–æ–≤–∏–π –∫–æ–ª—ñ—Ä.
         * @returns {string} –®—ñ—Å—Ç–Ω–∞–¥—Ü—è—Ç–∫–æ–≤–∏–π –∫–æ–¥ –∫–æ–ª—å–æ—Ä—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, #1a2b3c).
         */
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        /**
         * –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î —Å—ñ—Ç–∫—É –∑ –ø–æ—á–∞—Ç–∫–æ–≤–∏–º –∫–æ–ª—å–æ—Ä–æ–º (–ø—Ä–æ–∑–æ—Ä–∏–º –∞–±–æ –±—ñ–ª–∏–º).
         * @param {number} size - –†–æ–∑–º—ñ—Ä —Å—ñ—Ç–∫–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 16 –¥–ª—è 16x16).
         */
        function initializeGrid(size) {
            GRID_SIZE = size;
            PIXEL_DATA = Array(size).fill(0).map(() => Array(size).fill(null)); // null –¥–ª—è –ø—Ä–æ–∑–æ—Ä–æ—Å—Ç—ñ
            resizeCanvas();
            drawCanvas();
        }

        /**
         * –ê–¥–∞–ø—Ç—É—î —Ä–æ–∑–º—ñ—Ä –∫–∞–Ω–≤–∞—Å—É –¥–æ —Ä–æ–∑–º—ñ—Ä—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.
         */
        function resizeCanvas() {
            const containerWidth = canvasContainer.clientWidth;
            // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ä–æ–∑–º—ñ—Ä –∫–∞–Ω–≤–∞—Å—É —è–∫ –∫–≤–∞–¥—Ä–∞—Ç
            canvas.width = containerWidth;
            canvas.height = containerWidth;
        }

        /**
         * –í–∏–∫–æ–Ω—É—î –ø–æ–≤–Ω–µ –ø–µ—Ä–µ–º–∞–ª—å–æ–≤—É–≤–∞–Ω–Ω—è –∫–∞–Ω–≤–∞—Å—É –Ω–∞ –æ—Å–Ω–æ–≤—ñ PIXEL_DATA.
         */
        function drawCanvas() {
            const cellSize = canvas.width / GRID_SIZE;
            
            // 1. –û—á–∏—Å—Ç–∏—Ç–∏ –∫–∞–Ω–≤–∞—Å
            ctx.fillStyle = '#ffffff'; // –ó–∞–ª–∏—Ç–∏ –±—ñ–ª–∏–º –∫–æ–ª—å–æ—Ä–æ–º —è–∫ –±–∞–∑–æ–≤–∏–π —Ñ–æ–Ω
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 2. –ù–∞–º–∞–ª—é–≤–∞—Ç–∏ –≤—Å—ñ –ø—ñ–∫—Å–µ–ª—ñ –∑ PIXEL_DATA
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    const color = PIXEL_DATA[r][c];
                    if (color) {
                        ctx.fillStyle = color;
                        ctx.fillRect(c * cellSize, r * cellSize, cellSize, cellSize);
                    }
                }
            }

            // 3. –ù–∞–º–∞–ª—é–≤–∞—Ç–∏ —Å—ñ—Ç–∫—É
            ctx.strokeStyle = '#e5e7eb'; // –õ–µ–≥–∫–∏–π —Å—ñ—Ä–∏–π –∫–æ–ª—ñ—Ä –¥–ª—è –ª—ñ–Ω—ñ–π —Å—ñ—Ç–∫–∏
            ctx.lineWidth = 1;

            for (let i = 0; i <= GRID_SIZE; i++) {
                // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ñ –ª—ñ–Ω—ñ—ó
                ctx.beginPath();
                ctx.moveTo(0, i * cellSize);
                ctx.lineTo(canvas.width, i * cellSize);
                ctx.stroke();

                // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ñ –ª—ñ–Ω—ñ—ó
                ctx.beginPath();
                ctx.moveTo(i * cellSize, 0);
                ctx.lineTo(i * cellSize, canvas.height);
                ctx.stroke();
            }
        }

        /**
         * –í–∏–∫–æ–Ω—É—î –∞–ª–≥–æ—Ä–∏—Ç–º –∑–∞–ª–∏–≤–∫–∏ Flood Fill.
         */
        function floodFill(startRow, startCol, newColor) {
            const targetColor = PIXEL_DATA[startRow][startCol];
            
            // –Ø–∫—â–æ —Ü—ñ–ª—å–æ–≤–∏–π –∫–æ–ª—ñ—Ä –≤–∂–µ —Ç–∞–∫–∏–π —Å–∞–º–∏–π, —è–∫ –Ω–æ–≤–∏–π –∫–æ–ª—ñ—Ä
            if (targetColor === newColor) {
                return;
            }

            const queue = [[startRow, startCol]];
            const R = GRID_SIZE;
            const C = GRID_SIZE;

            while (queue.length > 0) {
                const [r, c] = queue.shift();

                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –º–µ–∂
                if (r < 0 || r >= R || c < 0 || c >= C) {
                    continue;
                }

                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–ª—å–æ—Ä—É: –∑–∞–ª–∏–≤–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –ø—ñ–∫—Å–µ–ª—ñ, —â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å targetColor
                if (PIXEL_DATA[r][c] !== targetColor) {
                    continue;
                }

                // –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –∫–æ–ª—å–æ—Ä—É
                PIXEL_DATA[r][c] = newColor;

                // –î–æ–¥–∞–≤–∞–Ω–Ω—è —Å—É—Å—ñ–¥—ñ–≤ —É —á–µ—Ä–≥—É
                queue.push([r + 1, c]); 
                queue.push([r - 1, c]); 
                queue.push([r, c + 1]); 
                queue.push([r, c - 1]); 
            }
            
            drawCanvas(); // –ü–æ–≤–Ω–µ –ø–µ—Ä–µ–º–∞–ª—å–æ–≤—É–≤–∞–Ω–Ω—è –ø—ñ—Å–ª—è –∑–∞–ª–∏–≤–∫–∏
        }


        /**
         * –û–±—Ä–æ–±–ª—è—î –ø–æ–¥—ñ—é –º–∞–ª—é–≤–∞–Ω–Ω—è (–∑–º—ñ–Ω–∏ –∫–æ–ª—å–æ—Ä—É –ø—ñ–∫—Å–µ–ª—è).
         */
        function handleDrawing(e, isSingleClick = false) {
            if (!isDrawing && currentTool !== 'fill' && e.type !== 'mousedown' && e.type !== 'touchstart') return;
            if (currentTool === 'fill' && !isSingleClick) return;
            
            const rect = canvas.getBoundingClientRect();
            
            let clientX, clientY;
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            const x = clientX - rect.left;
            const y = clientY - rect.top;

            const cellSize = canvas.width / GRID_SIZE;
            const col = Math.floor(x / cellSize);
            const row = Math.floor(y / cellSize);

            if (row >= 0 && row < GRID_SIZE && col >= 0 && col < GRID_SIZE) {
                
                if (currentTool === 'fill') {
                    floodFill(row, col, currentColor);
                } else {
                    let colorToApply = null;

                    if (currentTool === 'eraser') {
                        colorToApply = null;
                    } else if (currentTool === 'rainbow') {
                        // –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –∫–æ–ª—å–æ—Ä—É –≤–µ—Å–µ–ª–∫–∏
                        colorToApply = RAINBOW_COLORS[rainbowIndex];
                        rainbowIndex = (rainbowIndex + 1) % RAINBOW_COLORS.length;
                    } else if (currentTool === 'random') { // –õ–æ–≥—ñ–∫–∞ —Ä–∞–Ω–¥–æ–º–Ω–æ–≥–æ –ø–µ–Ω–∑–ª–∏–∫–∞
                        colorToApply = getRandomColor();
                    } 
                    else { // 'pen'
                        colorToApply = currentColor;
                    }
                    
                    if (PIXEL_DATA[row][col] !== colorToApply) { 
                        PIXEL_DATA[row][col] = colorToApply;
                        
                        if (colorToApply) {
                            ctx.fillStyle = colorToApply;
                            ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                        } else {
                            // –û—á–∏—â–µ–Ω–Ω—è –ø—ñ–∫—Å–µ–ª—è –¥–æ –±—ñ–ª–æ–≥–æ —Ñ–æ–Ω—É
                            ctx.fillStyle = '#ffffff';
                            ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                        }

                        // –ü–µ—Ä–µ–º–∞–ª—å–æ–≤—É–≤–∞–Ω–Ω—è –ª—ñ–Ω—ñ–π —Å—ñ—Ç–∫–∏ –Ω–∞–≤–∫–æ–ª–æ –ø—ñ–∫—Å–µ–ª—è
                        drawCanvasLines(col, row, cellSize);
                    }
                }
            }
        }

        /**
         * –ü–µ—Ä–µ–º–∞–ª—å–æ–≤—É—î –ª—ñ–Ω—ñ—ó —Å—ñ—Ç–∫–∏, —è–∫—ñ –º–æ–≥–ª–∏ –±—É—Ç–∏ –∑–∞—Ç–µ—Ä—Ç—ñ –ø—ñ–∫—Å–µ–ª–µ–º.
         */
        function drawCanvasLines(col, row, cellSize) {
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;

            const linesToRedraw = [
                [col * cellSize, row * cellSize, (col + 1) * cellSize, row * cellSize],
                [col * cellSize, (row + 1) * cellSize, (col + 1) * cellSize, (row + 1) * cellSize],
                [col * cellSize, row * cellSize, col * cellSize, (row + 1) * cellSize],
                [(col + 1) * cellSize, row * cellSize, (col + 1) * cellSize, (row + 1) * cellSize],
            ];

            linesToRedraw.forEach(([x1, y1, x2, y2]) => {
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
            });
        }
        
        /**
         * –í—Å—Ç–∞–Ω–æ–≤–ª—é—î –∞–∫—Ç–∏–≤–Ω–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —ñ –æ–Ω–æ–≤–ª—é—î UI.
         */
        function setTool(tool) {
            currentTool = tool;
            
            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≥–æ–ª–æ–≤–Ω–æ—ó –∫–Ω–æ–ø–∫–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É
            const toolInfo = toolMap[tool];
            toolIcon.textContent = toolInfo.icon;
            toolNameDisplay.textContent = toolInfo.name;
            
            // –ó–º—ñ–Ω–∞ –∫–æ–ª—å–æ—Ä—É –≥–æ–ª–æ–≤–Ω–æ—ó –∫–Ω–æ–ø–∫–∏
            const allColors = ['bg-blue-600', 'bg-green-600', 'bg-indigo-600', 'bg-pink-600', 'bg-yellow-600'];
            const allHoverColors = allColors.map(c => c.replace('600', '700'));

            mainToolButton.classList.remove(...allColors, ...allHoverColors);
            
            mainToolButton.classList.add(toolInfo.color, `hover:${toolInfo.color.replace('600', '700')}`);
            
            // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –≤–∏–ª—ñ—Ç–∞—é—á–∏–π —Å–ø–∏—Å–æ–∫
            toolFlyout.classList.add('hidden');
            toolArrow.classList.remove('rotate-180');
        }

        /**
         * –í—ñ–¥–æ–±—Ä–∞–∂–∞—î —Ç–∏–º—á–∞—Å–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —Å—Ç–∞–Ω.
         */
        function showMessage(text, classes) {
            statusMessage.textContent = text;
            statusMessage.className = `text-center mt-4 p-3 rounded-lg ${classes}`;
            statusMessage.classList.remove('hidden');
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 3000);
        }

        /**
         * –û—Ç—Ä–∏–º—É—î –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –∫–æ–ª–µ–∫—Ü—ñ—é Firestore –¥–ª—è –æ—Å–æ–±–∏—Å—Ç–∏—Ö —Ä–æ–±—ñ—Ç.
         */
        function getCollectionRef() {
            if (!db || !userId) return null;
            // –ü—Ä–∏–≤–∞—Ç–Ω–∏–π —à–ª—è—Ö: /artifacts/{appId}/users/{userId}/saved_art
            return collection(db, 'artifacts', appId, 'users', userId, 'saved_art');
        }

        /**
         * –ó–±–µ—Ä—ñ–≥–∞—î –ø–æ—Ç–æ—á–Ω–∏–π –∞—Ä—Ç —É Firestore.
         */
        async function saveArt() {
            if (!isAuthReady) {
                showMessage("–ü–æ–º–∏–ª–∫–∞: –ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ó–∞—á–µ–∫–∞–π—Ç–µ.", "bg-red-100 text-red-700");
                return;
            }
            
            const artName = prompt("–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –¥–ª—è –≤–∞—à–æ–≥–æ —à–µ–¥–µ–≤—Ä—É:"); 

            if (!artName || artName.trim() === "") {
                showMessage("–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ.", "bg-yellow-100 text-yellow-700");
                return;
            }
            
            try {
                // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö —è–∫ JSON-—Ä—è–¥–æ–∫ (—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –≤–∫–ª–∞–¥–µ–Ω–æ–≥–æ –º–∞—Å–∏–≤—É)
                const docRef = await addDoc(getCollectionRef(), {
                    name: artName.trim(),
                    gridSize: GRID_SIZE,
                    data: JSON.stringify(PIXEL_DATA), 
                    createdAt: Date.now()
                });
                showMessage(`–ó–±–µ—Ä–µ–∂–µ–Ω–æ —è–∫: "${artName.trim()}"`, "bg-green-100 text-green-700");
            } catch (e) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∞: ", e);
                showMessage("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ!", "bg-red-100 text-red-700");
            }
        }

        /**
         * –ù–∞–ª–∞—à—Ç–æ–≤—É—î —Å–ª—É—Ö–∞—á–∞, —è–∫–∏–π –æ–Ω–æ–≤–ª—é—î —Å–ø–∏—Å–æ–∫ savedArts —É —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ.
         */
        function setupGalleryListener() {
            const colRef = getCollectionRef();
            if (!colRef) return;

            // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ onSnapshot –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –æ–Ω–æ–≤–ª–µ–Ω—å —É —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ
            onSnapshot(colRef, (snapshot) => {
                savedArts = [];
                snapshot.forEach((doc) => {
                    savedArts.push({ id: doc.id, ...doc.data() });
                });
                
                // –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –∑–∞ –¥–∞—Ç–æ—é —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è (–Ω–∞–π–Ω–æ–≤—ñ—à—ñ –∑–≤–µ—Ä—Ö—É) –≤ –ø–∞–º'—è—Ç—ñ
                savedArts.sort((a, b) => b.createdAt - a.createdAt);
                
                renderGalleryList();
            }, (error) => {
                console.error("–ü–æ–º–∏–ª–∫–∞ —Å–ª—É—Ö–∞—á–∞ –≥–∞–ª–µ—Ä–µ—ó: ", error);
                showMessage("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≥–∞–ª–µ—Ä–µ—ó.", "bg-red-100 text-red-700");
            });
        }

        /**
         * –†–µ–Ω–¥–µ—Ä–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–æ–±—ñ—Ç —É –º–æ–¥–∞–ª—å–Ω–æ–º—É –≤—ñ–∫–Ω—ñ –ì–∞–ª–µ—Ä–µ—ó.
         */
        function renderGalleryList() {
            galleryList.innerHTML = '';
            
            if (savedArts.length === 0) {
                galleryList.innerHTML = '<p class="text-gray-500 text-center py-4">–í–∞—à–∞ –≥–∞–ª–µ—Ä–µ—è –ø–æ—Ä–æ–∂–Ω—è. –ó–±–µ—Ä–µ–∂—ñ—Ç—å —Å–≤—ñ–π –ø–µ—Ä—à–∏–π –∞—Ä—Ç!</p>';
                return;
            }

            savedArts.forEach(art => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-3 bg-gray-50 hover:bg-gray-100 rounded-lg shadow-sm mb-2 transition duration-150';
                
                // –ö–Ω–æ–ø–∫–∞ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏
                const loadBtn = document.createElement('button');
                loadBtn.textContent = `${art.name} (${art.gridSize}x${art.gridSize})`;
                loadBtn.className = 'text-left font-medium text-gray-800 hover:text-blue-600 transition duration-150 truncate flex-1';
                loadBtn.title = `–ö–ª—ñ–∫–Ω—ñ—Ç—å, —â–æ–± –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ "${art.name}"`;
                loadBtn.onclick = () => loadArtFromFirestore(art);
                
                // –ö–Ω–æ–ø–∫–∞ –í–∏–¥–∞–ª–∏—Ç–∏
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '‚ùå <span class="hidden sm:inline">–í–∏–¥–∞–ª–∏—Ç–∏</span>';
                deleteBtn.className = 'ml-4 p-2 text-sm text-red-500 rounded-lg hover:bg-red-100 transition duration-150';
                deleteBtn.title = '–í–∏–¥–∞–ª–∏—Ç–∏';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation(); // –ó–∞–ø–æ–±—ñ–≥—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—é –ø—Ä–∏ –∫–ª—ñ–∫—É –Ω–∞ –∫–Ω–æ–ø–∫—É –≤–∏–¥–∞–ª–µ–Ω–Ω—è
                    deleteArt(art.id, art.name);
                };
                
                item.appendChild(loadBtn);
                item.appendChild(deleteBtn);
                galleryList.appendChild(item);
            });
        }

        /**
         * –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î –≤–∏–±—Ä–∞–Ω–∏–π –∞—Ä—Ç –Ω–∞ –∫–∞–Ω–≤–∞—Å.
         */
        function loadArtFromFirestore(art) {
            try {
                const data = JSON.parse(art.data);
                
                GRID_SIZE = art.gridSize;
                PIXEL_DATA = data;
                
                gridSizeSlider.value = GRID_SIZE;
                gridSizeValueDisplay.textContent = `${GRID_SIZE}x${GRID_SIZE}`;

                resizeCanvas();
                drawCanvas();
                
                showMessage(`–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: "${art.name}"`, "bg-green-100 text-green-700");
                galleryModal.classList.add('hidden'); // –ó–∞–∫—Ä–∏—Ç–∏ –≥–∞–ª–µ—Ä–µ—é
            } catch (e) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ/–ø–∞—Ä—Å–∏–Ω–≥—É –¥–∞–Ω–∏—Ö: ", e);
                showMessage("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö!", "bg-red-100 text-red-700");
            }
        }

        /**
         * –í–∏–¥–∞–ª—è—î –∞—Ä—Ç –∑ Firestore.
         */
        async function deleteArt(docId, name) {
            if (!isAuthReady) {
                showMessage("–ü–æ–º–∏–ª–∫–∞: –ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.", "bg-red-100 text-red-700");
                return;
            }

            // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ prompt —è–∫ –∑–∞–º—ñ–Ω–Ω–∏–∫ confirm() –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
            const confirmation = prompt(`–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ "${name}"?\n(–í–≤–µ–¥—ñ—Ç—å '—Ç–∞–∫' –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è)`);
            if (confirmation?.toLowerCase() !== '—Ç–∞–∫') {
                return;
            }

            try {
                await deleteDoc(doc(getCollectionRef(), docId));
                // –°–ø–∏—Å–æ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ onSnapshot
                showMessage(`–í–∏–¥–∞–ª–µ–Ω–æ: "${name}"`, "bg-red-100 text-red-700");
            } catch (e) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∞: ", e);
                showMessage("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ!", "bg-red-100 text-red-700");
            }
        }


        // ---------------------------------------------
        // –û–±—Ä–æ–±–Ω–∏–∫–∏ –ü–æ–¥—ñ–π
        // ---------------------------------------------

        // 1. –ü–æ–¥—ñ—ó –º–∏—à—ñ/–¥–æ—Ç–∏–∫—É –¥–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è/—Å—Ç–∏—Ä–∞–Ω–Ω—è/–∑–∞–ª–∏–≤–∫–∏
        canvas.addEventListener('mousedown', (e) => {
            e.preventDefault();
            if (currentTool === 'fill') {
                handleDrawing(e, true); 
                isDrawing = false;
            } else {
                isDrawing = true;
                handleDrawing(e);
            }
        });
        canvas.addEventListener('mousemove', (e) => {
            if (isDrawing && currentTool !== 'fill') {
                e.preventDefault();
                handleDrawing(e);
            }
        });
        document.addEventListener('mouseup', () => {
            isDrawing = false;
        });

        // –î–æ—Ç–∏–∫ (–¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤)
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (currentTool === 'fill') {
                handleDrawing(e, true);
                isDrawing = false;
            } else {
                isDrawing = true;
                handleDrawing(e);
            }
        }, { passive: false });
        
        canvas.addEventListener('touchmove', (e) => {
            if (isDrawing && currentTool !== 'fill') {
                e.preventDefault();
                handleDrawing(e);
            }
        }, { passive: false });
        
        document.addEventListener('touchend', () => {
            isDrawing = false;
        });


        // 2. –ó–º—ñ–Ω–∞ –∫–æ–ª—å–æ—Ä—É (–ø—Ä–∏ –∑–º—ñ–Ω—ñ –∫–æ–ª—å–æ—Ä—É –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –¥–æ –∑–≤–∏—á–∞–π–Ω–æ–≥–æ –æ–ª—ñ–≤—Ü—è)
        colorPicker.addEventListener('input', (e) => {
            currentColor = e.target.value;
            // –Ø–∫—â–æ –≤–∏–±—Ä–∞–Ω–æ —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏–π –∫–æ–ª—ñ—Ä, –ø–µ—Ä–µ–º–∏–∫–∞—î–º–æ –Ω–∞ 'pen', —è–∫—â–æ –∞–∫—Ç–∏–≤–Ω–∏–π –Ω–µ 'fill' –∞–±–æ 'eraser'
            if (currentTool !== 'fill' && currentTool !== 'eraser') {
                setTool('pen'); 
            }
        });

        // 3. –ó–º—ñ–Ω–∞ —Ä–æ–∑–º—ñ—Ä—É —Å—ñ—Ç–∫–∏
        gridSizeSlider.addEventListener('input', (e) => {
            const newSize = parseInt(e.target.value);
            gridSizeValueDisplay.textContent = `${newSize}x${newSize}`;
            if (newSize !== GRID_SIZE) {
                initializeGrid(newSize);
            }
        });
        
        // 4. –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ (Flyout logic)
        mainToolButton.addEventListener('click', () => {
            const isHidden = toolFlyout.classList.toggle('hidden');
            if (isHidden) {
                toolArrow.classList.remove('rotate-180');
            } else {
                toolArrow.classList.add('rotate-180');
            }
        });

        // –û–±—Ä–æ–±–Ω–∏–∫–∏ –∫–ª—ñ–∫—É –Ω–∞ –µ–ª–µ–º–µ–Ω—Ç–∏ —Å–ø–∏—Å–∫—É —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤
        document.getElementById('penToolButton').addEventListener('click', (e) => setTool(e.currentTarget.dataset.tool));
        document.getElementById('rainbowToolButton').addEventListener('click', (e) => setTool(e.currentTarget.dataset.tool)); 
        document.getElementById('randomToolButton').addEventListener('click', (e) => setTool(e.currentTarget.dataset.tool)); // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è —Ä–∞–Ω–¥–æ–º–Ω–æ–≥–æ –ø–µ–Ω–∑–ª–∏–∫–∞
        document.getElementById('eraserToolButton').addEventListener('click', (e) => setTool(e.currentTarget.dataset.tool));
        document.getElementById('fillToolButton').addEventListener('click', (e) => setTool(e.currentTarget.dataset.tool));

        // –ó–∞–∫—Ä–∏—Ç—Ç—è flyout –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–∏–º
        document.addEventListener('click', (e) => {
            const toolContainer = mainToolButton.closest('.relative');
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∫–ª—ñ–∫ –±—É–≤ –ø–æ–∑–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ —ñ —á–∏ flyout –≤—ñ–¥–∫—Ä–∏—Ç–∏–π
            if (!toolContainer.contains(e.target) && !toolFlyout.classList.contains('hidden')) {
                toolFlyout.classList.add('hidden');
                toolArrow.classList.remove('rotate-180');
            }
        });
        
        // 5. –ö–Ω–æ–ø–∫–∏ –¥—ñ–π
        clearButton.addEventListener('click', () => {
            initializeGrid(GRID_SIZE); 
            showMessage("–ö–∞–Ω–≤–∞—Å –æ—á–∏—â–µ–Ω–æ!", "bg-green-100 text-green-700");
        });
        
        saveButton.addEventListener('click', saveArt); 
        
        galleryButton.addEventListener('click', () => { 
            if (isAuthReady) {
                galleryModal.classList.remove('hidden');
                renderGalleryList(); 
            } else {
                showMessage("–ó–∞—á–µ–∫–∞–π—Ç–µ, –ø–æ–∫–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î—Ç—å—Å—è Firebase...", "bg-yellow-100 text-yellow-700");
            }
        });

        document.getElementById('closeGalleryButton').addEventListener('click', () => {
            galleryModal.classList.add('hidden');
        });


        // 6. –ö–Ω–æ–ø–∫–∞ "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PNG"
        downloadButton.addEventListener('click', () => {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            const outputSize = 512; 
            tempCanvas.width = outputSize;
            tempCanvas.height = outputSize;

            const cellSize = outputSize / GRID_SIZE;
            
            tempCtx.fillStyle = '#ffffff';
            tempCtx.fillRect(0, 0, outputSize, outputSize);

            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    const color = PIXEL_DATA[r][c];
                    if (color) {
                        tempCtx.fillStyle = color;
                        tempCtx.fillRect(
                            Math.floor(c * cellSize), 
                            Math.floor(r * cellSize), 
                            Math.ceil(cellSize), 
                            Math.ceil(cellSize)
                        );
                    }
                }
            }
            
            const dataURL = tempCanvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = dataURL;
            a.download = `pixel_art_${GRID_SIZE}x${GRID_SIZE}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showMessage("–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è PNG –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!", "bg-blue-100 text-blue-700");
        });

        // 7. –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å (–ø–µ—Ä–µ–º–∞–ª—å–æ–≤—É–≤–∞–Ω–Ω—è –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ä–æ–∑–º—ñ—Ä—É –≤—ñ–∫–Ω–∞)
        window.addEventListener('resize', () => {
            resizeCanvas();
            drawCanvas();
        });

        // 8. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
        window.onload = function() {
            setupFirebase(); // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Firebase
            initializeGrid(GRID_SIZE);
            setTool('pen'); 
        };

    </script>
</body>
</html>